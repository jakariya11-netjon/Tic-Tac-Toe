<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pro Tic Tac Toe Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Animated Gaming Background */
        body { 
            margin:0; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #1e293b);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            color:#fff; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            height:100vh; 
            overflow: hidden;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container { 
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            padding: 30px; 
            border-radius: 20px; 
            width: 340px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }

        h2 { margin-top: 0; letter-spacing: 1px; color: #60a5fa; }

        input, button { 
            width:100%; padding:14px; margin:10px 0; border-radius: 10px; 
            border:none; font-size:16px; box-sizing: border-box; transition: 0.3s;
        }

        input { background: #334155; color: white; outline: none; border: 1px solid #475569; }
        input:focus { border-color: #3b82f6; }

        button { background: #3b82f6; color: white; font-weight: bold; cursor:pointer; text-transform: uppercase; }
        button:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }

        .board { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:20px; }
        .cell { 
            height:90px; background: rgba(51, 65, 85, 0.6); font-size:42px; 
            display:flex; justify-content:center; align-items:center; 
            cursor:pointer; border-radius: 12px; transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
            font-weight: bold;
        }
        .cell:hover { background: rgba(71, 85, 105, 0.8); }

        .hidden { display:none; }
        #roomDisplay { font-weight: bold; color: #10b981; font-size: 22px; letter-spacing: 3px; margin: 5px 0; }
        #turnInfo { font-size: 18px; color: #94a3b8; margin-bottom: 10px; }
        
        .x-mark { color: #60a5fa; text-shadow: 0 0 15px rgba(96, 165, 250, 0.6); }
        .o-mark { color: #f87171; text-shadow: 0 0 15px rgba(248, 113, 113, 0.6); }
    </style>
</head>
<body>

<div class="container">
    <h2>TIC TAC TOE</h2>

    <div id="roomUI">
        <button onclick="createRoom()">Create New Game</button>
        <div style="margin: 15px 0; color: #94a3b8; font-size: 14px;">â€” OR â€”</div>
        <input id="roomInput" placeholder="Enter 5-digit code">
        <button style="background: #10b981;" onclick="joinRoom()">Join Game</button>
    </div>

    <div id="gameUI" class="hidden">
        <div id="roomDisplay"></div>
        <p id="playerInfo" style="margin: 5px 0; opacity: 0.8;"></p>
        <p id="turnInfo">Waiting for opponent...</p>

        <div class="board">
            <div class="cell" onclick="move(0)"></div>
            <div class="cell" onclick="move(1)"></div>
            <div class="cell" onclick="move(2)"></div>
            <div class="cell" onclick="move(3)"></div>
            <div class="cell" onclick="move(4)"></div>
            <div class="cell" onclick="move(5)"></div>
            <div class="cell" onclick="move(6)"></div>
            <div class="cell" onclick="move(7)"></div>
            <div class="cell" onclick="move(8)"></div>
        </div>
    </div>
</div>

<audio id="sound-tap" src="https://raw.githubusercontent.com/jakariya11-netjon/Tic-Tac-Toe/main/pop-402322.mp3"></audio>
<audio id="sound-win" src="https://raw.githubusercontent.com/jakariya11-netjon/Tic-Tac-Toe/main/loud-fanfare-trumpet-effect-05-412046.mp3"></audio>
<audio id="sound-loss" src="https://raw.githubusercontent.com/jakariya11-netjon/Tic-Tac-Toe/main/loss.mp3"></audio>
<audio id="sound-draw" src="https://raw.githubusercontent.com/jakariya11-netjon/Tic-Tac-Toe/main/tie.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyB78J0GqZUvjmAmUsmHCTLO3vIqhQq1N8",
    authDomain: "tic-tac-toe-online-8af06.firebaseapp.com",
    databaseURL: "https://tic-tac-toe-online-8af06-default-rtdb.firebaseio.com",
    projectId: "tic-tac-toe-online-8af06",
    storageBucket: "tic-tac-toe-online-8af06.firebasestorage.app",
    messagingSenderId: "539479661784",
    appId: "1:539479661784:web:078147d1569fbd93280bad"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let roomCode = "";
let playerSign = "";
let gameActive = false;
let isResetting = false;

function playSound(id) {
    const s = document.getElementById(id);
    if(s) {
        s.currentTime = 0;
        s.play().catch(e => console.log("Interaction needed for sound"));
    }
}

function createRoom() {
    roomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
    playerSign = "X";
    db.ref("rooms/" + roomCode).set({
        board: ["", "", "", "", "", "", "", "", ""],
        turn: "X",
        startingPlayer: "X", // Keep track of who started
        status: "waiting"
    });
    showGameUI();
}

function joinRoom() {
    const input = document.getElementById("roomInput").value.trim().toUpperCase();
    if (!input) return;
    db.ref("rooms/" + input).once("value", snap => {
        if (!snap.exists()) return alert("Room not found!");
        roomCode = input;
        playerSign = "O";
        db.ref("rooms/" + roomCode).update({ status: "playing" });
        showGameUI();
    });
}

function showGameUI() {
    document.getElementById("roomUI").classList.add("hidden");
    document.getElementById("gameUI").classList.remove("hidden");
    document.getElementById("roomDisplay").innerText = roomCode;
    document.getElementById("playerInfo").innerText = "You are: " + playerSign;
    listenForUpdates();
}

function listenForUpdates() {
    db.ref("rooms/" + roomCode).on("value", snap => {
        const data = snap.val();
        if (!data) return;

        const cells = document.querySelectorAll(".cell");
        data.board.forEach((val, i) => {
            cells[i].innerText = val;
            cells[i].className = val === "X" ? "cell x-mark" : val === "O" ? "cell o-mark" : "cell";
        });

        if (data.status === "waiting") {
            document.getElementById("turnInfo").innerText = "Waiting for friend...";
            gameActive = false;
        } else if (data.status === "playing") {
            gameActive = true;
            document.getElementById("turnInfo").innerText = (data.turn === playerSign) ? "YOUR TURN" : "FRIEND'S TURN...";
            document.getElementById("turnInfo").style.color = (data.turn === playerSign) ? "#10b981" : "#94a3b8";
        }

        const winner = checkWinner(data.board);
        if (winner && !isResetting) {
            handleGameOver(winner, data.startingPlayer);
        }
    });
}

function move(index) {
    if (!gameActive) return;
    db.ref("rooms/" + roomCode).once("value", snap => {
        const data = snap.val();
        if (data.turn === playerSign && data.board[index] === "" && data.status === "playing") {
            playSound('sound-tap');
            data.board[index] = playerSign;
            data.turn = (playerSign === "X") ? "O" : "X";
            db.ref("rooms/" + roomCode).update(data);
        }
    });
}

function handleGameOver(winner, lastStarter) {
    gameActive = false;
    isResetting = true;

    if (winner === "draw") {
        playSound('sound-draw');
        document.getElementById("turnInfo").innerText = "IT'S A TIE!";
    } else if (winner === playerSign) {
        playSound('sound-win');
        document.getElementById("turnInfo").innerText = "YOU WIN! ðŸŽ‰";
    } else {
        playSound('sound-loss');
        document.getElementById("turnInfo").innerText = "YOU LOST... ðŸ’€";
    }

    // Determine next starter (Switch between X and O)
    const nextStarter = (lastStarter === "X") ? "O" : "X";

    setTimeout(() => {
        // Only X (the creator) manages the database reset to prevent conflicts
        if (playerSign === "X") {
            db.ref("rooms/" + roomCode).update({
                board: ["", "", "", "", "", "", "", "", ""],
                turn: nextStarter,
                startingPlayer: nextStarter,
                status: "playing"
            });
        }
        isResetting = false;
    }, 3000);
}

function checkWinner(b) {
    const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for (let combo of wins) {
        if (b[combo[0]] && b[combo[0]] === b[combo[1]] && b[combo[1]] === b[combo[2]]) 
            return b[combo[0]];
    }
    if (b.every(cell => cell !== "")) return "draw";
    return null;
}
</script>
</body>
</html>
